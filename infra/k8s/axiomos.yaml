apiVersion: v1
kind: Namespace
metadata:
  name: axiomos
---
apiVersion: batch/v1
kind: Job
metadata:
  name: migrator
  namespace: axiomos
spec:
  template:
    metadata:
      labels:
        app: migrator
    spec:
      restartPolicy: OnFailure
      containers:
        - name: migrator
          image: axiom:v0.1.0
          command: ["/app/migrator"]
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: DATABASE_URL
            - {name: DATABASE_REQUIRE_TLS, value: "true"}
            - {name: DB_TENANT_SCOPE, value: ""}
            - {name: DB_TENANT_STATIC, value: ""}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: postgres}
  template:
    metadata:
      labels: {app: postgres}
    spec:
      containers:
        - name: postgres
          image: postgres:15.8-alpine
          command:
            - "postgres"
            - "-c"
            - "ssl=on"
            - "-c"
            - "ssl_cert_file=/var/lib/postgresql/certs/server.crt"
            - "-c"
            - "ssl_key_file=/var/lib/postgresql/certs/server.key"
            - "-c"
            - "ssl_ca_file=/var/lib/postgresql/certs/ca.crt"
          env:
            - {name: POSTGRES_USER, value: axiom}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: POSTGRES_PASSWORD
            - {name: POSTGRES_DB, value: axiom}
          ports:
            - {containerPort: 5432}
          volumeMounts:
            - name: postgres-tls
              mountPath: /var/lib/postgresql/certs
              readOnly: true
      volumes:
        - name: postgres-tls
          secret:
            secretName: axiomos-db-tls
            defaultMode: 0400
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: axiomos
spec:
  selector: {app: postgres}
  ports:
    - port: 5432
      targetPort: 5432
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: redis}
  template:
    metadata:
      labels: {app: redis}
    spec:
      containers:
        - name: redis
          image: redis:7.2.5-alpine
          command:
            - "sh"
            - "-c"
            - "redis-server --port 0 --tls-port 6379 --tls-cert-file /tls/tls.crt --tls-key-file /tls/tls.key --tls-ca-cert-file /tls/ca.crt --tls-auth-clients no --requirepass \"$REDIS_PASSWORD\""
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: axiomos-redis
                  key: REDIS_PASSWORD
          ports:
            - {containerPort: 6379}
          volumeMounts:
            - name: redis-tls
              mountPath: /tls
              readOnly: true
      volumes:
        - name: redis-tls
          secret:
            secretName: axiomos-redis-tls
            defaultMode: 0400
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: axiomos
spec:
  selector: {app: redis}
  ports:
    - port: 6379
      targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redpanda
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: redpanda}
  template:
    metadata:
      labels: {app: redpanda}
    spec:
      containers:
        - name: redpanda
          image: docker.redpanda.com/redpandadata/redpanda:v24.1.9
          args:
            - start
            - --smp
            - "1"
            - --overprovisioned
            - --memory
            - 512M
            - --reserve-memory
            - 0M
            - --node-id
            - "0"
            - --check=false
            - --kafka-addr
            - PLAINTEXT://0.0.0.0:9092
            - --advertise-kafka-addr
            - PLAINTEXT://redpanda:9092
          ports:
            - {containerPort: 9092}
---
apiVersion: v1
kind: Service
metadata:
  name: redpanda
  namespace: axiomos
spec:
  selector: {app: redpanda}
  ports:
    - port: 9092
      targetPort: 9092
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: policy
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: policy}
  template:
    metadata:
      labels: {app: policy}
    spec:
      containers:
        - name: policy
          image: axiom:v0.1.0
          command: ["/app/policy"]
          env:
            - {name: ADDR, value: ":8082"}
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: DATABASE_URL
            - {name: DATABASE_REQUIRE_TLS, value: "true"}
            - {name: DB_TENANT_SCOPE, value: ""}
            - {name: DB_TENANT_STATIC, value: ""}
            - {name: AUTH_MODE, value: "oidc_hs256"}
            - {name: ALLOW_INSECURE_AUTH_OFF, value: "false"}
            - {name: ENVIRONMENT, value: "production"}
            - {name: CORS_ALLOWED_ORIGINS, value: "https://console.example.com"}
            - name: OIDC_HS256_SECRET
              valueFrom:
                secretKeyRef:
                  name: axiomos-oidc
                  key: OIDC_HS256_SECRET
            - {name: OIDC_JWKS_URL, value: ""}
            - {name: OIDC_ISSUER, value: ""}
            - {name: OIDC_AUDIENCE, value: ""}
            - {name: AUTH_TIMEOUT_MS, value: "5000"}
            - {name: POLICY_AUTH_HEADER, value: "X-Axiom-Policy-Token"}
            - name: POLICY_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-policy
                  key: POLICY_AUTH_TOKEN
            - {name: MAX_REQUEST_BODY_BYTES, value: "1048576"}
            - {name: HTTP_READ_HEADER_TIMEOUT_SEC, value: "5"}
            - {name: HTTP_READ_TIMEOUT_SEC, value: "15"}
            - {name: HTTP_WRITE_TIMEOUT_SEC, value: "30"}
            - {name: HTTP_IDLE_TIMEOUT_SEC, value: "120"}
          ports:
            - {containerPort: 8082}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8082
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8082
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: policy
  namespace: axiomos
spec:
  selector: {app: policy}
  ports:
    - port: 8082
      targetPort: 8082
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: state
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: state}
  template:
    metadata:
      labels: {app: state}
    spec:
      containers:
        - name: state
          image: axiom:v0.1.0
          command: ["/app/state"]
          env:
            - {name: ADDR, value: ":8083"}
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: DATABASE_URL
            - {name: DATABASE_REQUIRE_TLS, value: "true"}
            - {name: DB_TENANT_SCOPE, value: ""}
            - {name: DB_TENANT_STATIC, value: ""}
            - {name: AUTH_MODE, value: "oidc_hs256"}
            - {name: ALLOW_INSECURE_AUTH_OFF, value: "false"}
            - {name: ENVIRONMENT, value: "production"}
            - {name: CORS_ALLOWED_ORIGINS, value: "https://console.example.com"}
            - name: OIDC_HS256_SECRET
              valueFrom:
                secretKeyRef:
                  name: axiomos-oidc
                  key: OIDC_HS256_SECRET
            - {name: OIDC_JWKS_URL, value: ""}
            - {name: OIDC_ISSUER, value: ""}
            - {name: OIDC_AUDIENCE, value: ""}
            - {name: AUTH_TIMEOUT_MS, value: "5000"}
            - {name: MAX_REQUEST_BODY_BYTES, value: "1048576"}
            - {name: HTTP_READ_HEADER_TIMEOUT_SEC, value: "5"}
            - {name: HTTP_READ_TIMEOUT_SEC, value: "15"}
            - {name: HTTP_WRITE_TIMEOUT_SEC, value: "30"}
            - {name: HTTP_IDLE_TIMEOUT_SEC, value: "120"}
            - {name: STATE_AUTH_HEADER, value: "X-Axiom-State-Token"}
            - name: STATE_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-state
                  key: STATE_AUTH_TOKEN
            - {name: KAFKA_ENABLED, value: "false"}
            - {name: KAFKA_BROKERS, value: redpanda:9092}
            - {name: KAFKA_TOPIC, value: axiom.state.events}
            - {name: KAFKA_GROUP_ID, value: axiom-state}
          ports:
            - {containerPort: 8083}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8083
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8083
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: state
  namespace: axiomos
spec:
  selector: {app: state}
  ports:
    - port: 8083
      targetPort: 8083
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: verifier
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: verifier}
  template:
    metadata:
      labels: {app: verifier}
    spec:
      containers:
        - name: verifier
          image: axiom:v0.1.0
          command: ["/app/verifier"]
          env:
            - {name: ADDR, value: ":8081"}
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: DATABASE_URL
            - {name: DATABASE_REQUIRE_TLS, value: "true"}
            - {name: POLICY_URL, value: http://policy:8082}
            - {name: STATE_URL, value: http://state:8083}
            - {name: SMT_ENABLED, value: "true"}
            - {name: SMT_BACKEND, value: "z3exec"}
            - {name: SMT_TIMEOUT_MS, value: "50"}
            - {name: Z3_PATH, value: "/usr/bin/z3"}
            - {name: AUTH_MODE, value: "oidc_hs256"}
            - {name: ALLOW_INSECURE_AUTH_OFF, value: "false"}
            - {name: ENVIRONMENT, value: "production"}
            - {name: CORS_ALLOWED_ORIGINS, value: "https://console.example.com"}
            - name: OIDC_HS256_SECRET
              valueFrom:
                secretKeyRef:
                  name: axiomos-oidc
                  key: OIDC_HS256_SECRET
            - {name: OIDC_JWKS_URL, value: ""}
            - {name: OIDC_ISSUER, value: ""}
            - {name: OIDC_AUDIENCE, value: ""}
            - {name: AUTH_TIMEOUT_MS, value: "5000"}
            - {name: POLICY_AUTH_HEADER, value: "X-Axiom-Policy-Token"}
            - name: POLICY_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-policy
                  key: POLICY_AUTH_TOKEN
            - {name: VERIFIER_AUTH_HEADER, value: "X-Axiom-Verifier-Token"}
            - name: VERIFIER_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-verifier
                  key: VERIFIER_AUTH_TOKEN
            - {name: KEYSTORE_PROVIDER, value: "db"}
            - {name: VAULT_ADDR, value: ""}
            - {name: VAULT_TOKEN, value: ""}
            - {name: VAULT_NAMESPACE, value: ""}
            - {name: VAULT_TRANSIT_MOUNT, value: "transit"}
            - {name: VAULT_KEY_PREFIX, value: ""}
            - {name: VAULT_KEY_LOOKUP_TIMEOUT_MS, value: "1500"}
            - {name: VAULT_KEY_LOOKUP_RETRIES, value: "1"}
            - {name: VAULT_KEY_LOOKUP_RETRY_DELAY_MS, value: "100"}
            - {name: MAX_REQUEST_BODY_BYTES, value: "1048576"}
            - {name: HTTP_READ_HEADER_TIMEOUT_SEC, value: "5"}
            - {name: HTTP_READ_TIMEOUT_SEC, value: "15"}
            - {name: HTTP_WRITE_TIMEOUT_SEC, value: "30"}
            - {name: HTTP_IDLE_TIMEOUT_SEC, value: "120"}
          ports:
            - {containerPort: 8081}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: verifier
  namespace: axiomos
spec:
  selector: {app: verifier}
  ports:
    - port: 8081
      targetPort: 8081
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-ontology
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: mock-ontology}
  template:
    metadata:
      labels: {app: mock-ontology}
    spec:
      containers:
        - name: mock-ontology
          image: axiom:v0.1.0
          command: ["/app/mock-ontology"]
          env:
            - {name: ADDR, value: ":8084"}
          ports:
            - {containerPort: 8084}
---
apiVersion: v1
kind: Service
metadata:
  name: mock-ontology
  namespace: axiomos
spec:
  selector: {app: mock-ontology}
  ports:
    - port: 8084
      targetPort: 8084
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tool-mock
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: tool-mock}
  template:
    metadata:
      labels: {app: tool-mock}
    spec:
      containers:
        - name: tool-mock
          image: axiom:v0.1.0
          command: ["/app/tool-mock"]
          env:
            - {name: ADDR, value: ":8085"}
          ports:
            - {containerPort: 8085}
---
apiVersion: v1
kind: Service
metadata:
  name: tool-mock
  namespace: axiomos
spec:
  selector: {app: tool-mock}
  ports:
    - port: 8085
      targetPort: 8085
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: axiomos
spec:
  replicas: 1
  selector:
    matchLabels: {app: gateway}
  template:
    metadata:
      labels: {app: gateway}
    spec:
      containers:
        - name: gateway
          image: axiom:v0.1.0
          command: ["/app/gateway"]
          env:
            - {name: ADDR, value: ":8080"}
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: axiomos-db
                  key: DATABASE_URL
            - {name: DATABASE_REQUIRE_TLS, value: "true"}
            - {name: DB_TENANT_SCOPE, value: ""}
            - {name: DB_TENANT_STATIC, value: ""}
            - {name: REDIS_ADDR, value: redis:6379}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: axiomos-redis
                  key: REDIS_PASSWORD
            - {name: REDIS_DB, value: "0"}
            - {name: REDIS_TLS, value: "true"}
            - {name: REDIS_REQUIRE_TLS, value: "true"}
            - {name: REDIS_TLS_INSECURE, value: "false"}
            - {name: REDIS_ALLOW_INSECURE_TLS, value: "false"}
            - {name: REDIS_TLS_SERVER_NAME, value: "redis"}
            - {name: REDIS_TLS_CA_CERT_FILE, value: "/etc/axiom/redis/ca.crt"}
            - {name: REDIS_TLS_CERT_FILE, value: ""}
            - {name: REDIS_TLS_KEY_FILE, value: ""}
            - {name: VERIFIER_URL, value: http://verifier:8081}
            - {name: STATE_URL, value: http://state:8083}
            - {name: TOOL_URL, value: http://tool-mock:8085}
            - {name: ONTOLOGY_URL, value: http://mock-ontology:8084}
            - {name: ONTOLOGY_ADAPTER, value: "mock"}
            - {name: FOUNDRY_BASE_URL, value: ""}
            - {name: FOUNDRY_TOKEN, value: ""}
            - {name: FOUNDRY_ONTOLOGY_ID, value: ""}
            - {name: FOUNDRY_ALLOW_BATCH, value: "true"}
            - {name: FOUNDRY_ALLOW_DRY_RUN, value: "true"}
            - {name: FOUNDRY_ALLOW_PREVIEW, value: "true"}
            - {name: SHIELD_STRICT_NO_COMMIT, value: "true"}
            - {name: DEGRADED_NO_ALLOW, value: "true"}
            - {name: AUTH_MODE, value: "oidc_hs256"}
            - {name: ALLOW_INSECURE_AUTH_OFF, value: "false"}
            - {name: ENVIRONMENT, value: "production"}
            - {name: CORS_ALLOWED_ORIGINS, value: "https://console.example.com"}
            - name: OIDC_HS256_SECRET
              valueFrom:
                secretKeyRef:
                  name: axiomos-oidc
                  key: OIDC_HS256_SECRET
            - {name: OIDC_JWKS_URL, value: ""}
            - {name: OIDC_ISSUER, value: ""}
            - {name: OIDC_AUDIENCE, value: ""}
            - {name: AUTH_TIMEOUT_MS, value: "5000"}
            - {name: MAX_REQUEST_BODY_BYTES, value: "1048576"}
            - {name: HTTP_READ_HEADER_TIMEOUT_SEC, value: "5"}
            - {name: HTTP_READ_TIMEOUT_SEC, value: "15"}
            - {name: HTTP_WRITE_TIMEOUT_SEC, value: "30"}
            - {name: HTTP_IDLE_TIMEOUT_SEC, value: "120"}
            - {name: VERIFIER_AUTH_HEADER, value: "X-Axiom-Verifier-Token"}
            - name: VERIFIER_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-verifier
                  key: VERIFIER_AUTH_TOKEN
            - {name: ABAC_DOMAIN_ROLES, value: "finance:financeoperator,financemanager;security:securityadmin"}
            - {name: ABAC_STRICT_ACTOR_BINDING, value: "true"}
            - name: AUDIT_HASH_SALT
              valueFrom:
                secretKeyRef:
                  name: axiomos-audit
                  key: AUDIT_HASH_SALT
            - {name: TRUSTED_PROXY_CIDRS, value: ""}
            - {name: RETENTION_ENABLED, value: "false"}
            - {name: RETENTION_DAYS, value: "90"}
            - {name: RETENTION_INTERVAL_SEC, value: "3600"}
            - {name: RATE_LIMIT_ENABLED, value: "true"}
            - {name: RATE_LIMIT_PER_MINUTE, value: "240"}
            - {name: RATE_LIMIT_WINDOW_SEC, value: "60"}
            - {name: STATE_AUTH_HEADER, value: "X-Axiom-State-Token"}
            - name: STATE_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: axiomos-state
                  key: STATE_AUTH_TOKEN
            - {name: KEYSTORE_PROVIDER, value: "db"}
            - {name: VAULT_ADDR, value: ""}
            - {name: VAULT_TOKEN, value: ""}
            - {name: VAULT_NAMESPACE, value: ""}
            - {name: VAULT_TRANSIT_MOUNT, value: "transit"}
            - {name: VAULT_KEY_PREFIX, value: ""}
            - {name: VAULT_KEY_LOOKUP_TIMEOUT_MS, value: "1500"}
            - {name: VAULT_KEY_LOOKUP_RETRIES, value: "1"}
            - {name: VAULT_KEY_LOOKUP_RETRY_DELAY_MS, value: "100"}
          ports:
            - {containerPort: 8080}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          volumeMounts:
            - name: redis-client-ca
              mountPath: /etc/axiom/redis
              readOnly: true
      volumes:
        - name: redis-client-ca
          secret:
            secretName: axiomos-redis-tls
            items:
              - key: ca.crt
                path: ca.crt
---
apiVersion: v1
kind: Service
metadata:
  name: gateway
  namespace: axiomos
spec:
  selector: {app: gateway}
  ports:
    - port: 8080
      targetPort: 8080
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-direct-mock-access
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: mock-ontology
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: gateway
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-direct-tool-access
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: tool-mock
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: gateway
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: axiomos
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gateway-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: axiomos
      ports:
        - protocol: TCP
          port: 8080
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: verifier
      ports:
        - protocol: TCP
          port: 8081
    - to:
        - podSelector:
            matchLabels:
              app: state
      ports:
        - protocol: TCP
          port: 8083
    - to:
        - podSelector:
            matchLabels:
              app: tool-mock
      ports:
        - protocol: TCP
          port: 8085
    - to:
        - podSelector:
            matchLabels:
              app: mock-ontology
      ports:
        - protocol: TCP
          port: 8084
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-verifier-traffic
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: verifier
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 8081
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: policy
      ports:
        - protocol: TCP
          port: 8082
    - to:
        - podSelector:
            matchLabels:
              app: state
      ports:
        - protocol: TCP
          port: 8083
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-policy-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: policy
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: verifier
      ports:
        - protocol: TCP
          port: 8082
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-state-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: state
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values: ["gateway", "verifier"]
      ports:
        - protocol: TCP
          port: 8083
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-state-egress-redpanda
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: state
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: redpanda
      ports:
        - protocol: TCP
          port: 9092
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redpanda-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: redpanda
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: state
      ports:
        - protocol: TCP
          port: 9092
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-policy-state-postgres
  namespace: axiomos
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values: ["policy", "state", "migrator"]
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values: ["gateway", "verifier", "policy", "state", "migrator"]
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-ingress
  namespace: axiomos
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 6379
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: axiomos
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
